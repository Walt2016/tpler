<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
	<title>inverter</title>
	<script src="js/tpler.js"></script>
	<style>
		    .box {
        width: 300px;
        height: 300px;
        /*background-image: url('image/cir.gif');*/
        /*background-size: 32px 32px;*/
        background-position: center center;
        background-repeat: no-repeat;
        border: 10px solid #ccc;
        margin-top: 20px;
        margin-left: 10px;
        position: relative;
    }
    .abs {
        position: absolute;
    }
    .debris{
    	width: 100px;
    	height: 100px;
    	background-color: #e0e0e0;
/*background-color: rgb(230, 171, 94)*/
    }

    .debris.active{
    	background-color: rgb(92, 144, 255);

    }
    .hide{
        display: none;
    }
	</style>
</head>
<body>
	<div class="container">
        <div class="box"></div>
    <div class="step"></div>
    <div class="success hide">成功！</div>
</div>
	<script>

		var inverter=function(el, imageSrc, row, col){

			var pos = _.pos(el)
        _.extend(this, pos)
        this.imageSrc = imageSrc;
        this.imgArr = [];
        this.posArr = [];
        this.step=0;

        this.bgArr=[];

			var row = this.row = row || 3;
        var col = this.col = col || 3;

        this.matrix(row, col);
        // this.randomImg();
        this.render(row, col)

		}
		inverter.prototype={
			  //生成 row * col 的矩阵
        matrix: function(row, col) {
            var row = row || 3;
            var col = col || 3;

            var debrisWidth = this.debrisWidth = this.width / row;
            var debrisHeight = this.debrisHeight = this.height / col;
            for (var i = 0; i < row; i++) {
                for (var j = 0; j < col; j++) {
                    var div = document.createElement('div');
                    div.className = "debris abs"
                    var index = i * col + j;
                    div.id = "debris_" + index;
                    div.setAttribute("index", index);
                    div.css({
                        'width': (debrisWidth - 2) + 'px',
                        'height': (debrisHeight - 2) + 'px',
                        'left': j * debrisWidth + 'px',
                        'top': i * debrisHeight + 'px',
                        // "backgroundImage": "url('" + this.imageSrc + "')",
                        // 'backgroundPosition': (-j) * debrisWidth + 'px ' + (-i) * debrisHeight + 'px'
                    });
                    this.imgArr.push(div);
                    this.posArr.push({
                        'left': j * debrisWidth + 'px',
                        'top': i * debrisHeight + 'px'
                    })
                    this.bgArr.push({
                    	"backgroundImage": "url('" + this.imageSrc + "')",
                        'backgroundPosition': (-j) * debrisWidth + 'px ' + (-i) * debrisHeight + 'px'
                    })
                }
            }
        },
         render: function(row, col) {
            var self = this;
            self.status = "ok"

            var fragment = document.createDocumentFragment();
            this.imgArr.forEach(function(t, index) {
                // var i = parseInt(index / col);
                // var j = index % col;
                // t.css({
                //     top: i * self.debrisHeight  + 'px', //+ boxPos.y
                //     left: j * self.debrisWidth  + 'px',//+ boxPos.x
                // })
                // t.css(self.posArr[index]);
                // t.css(self.bgArr[index])
                fragment.appendChild(t);
                if (t.attr("index") != index) {
                    self.status = "notok"
                }
            })
            // document.body.appendChild(fragment)

            _.$(".box").appendChild(fragment)//.empty()
            setTimeout(function(){
                if( self.status == "ok"&&self.step>0){
                 alert("ok")
                _.show(".success")
            }

            },500)
            

        },
        toggleImg:function(item){
        	if(item.hasClass('active')){
					item.removeClass("active");
					item.css({
						'background-image':'none'
					})
				}else{
					item.addClass('active');
					item.css(this.bgArr[item.attr("index")]);
				}

        },

        toggleColor:function(item){

        	if(item.hasClass('active')){
					item.removeClass("active")
				}else{
					item.addClass('active')
				}

        }
		}


   var img="image/"+_.random(["1","2","3","4","5","6","7","8","9"])+".jpg"
    _.loadImg(img, function(img) {
        var width = img.width;
        var height = img.height;

        _.$(".box").css({
            width: width + "px",
            height: height + "px"
        })


        var p = new inverter(".box", img.src, 3, 3)


		toucher({
			el:".debris",
			type:"touchstart",
			callback:function(item,ev){

				var index=parseInt(item.attr("index"))
				var col=p.col;

				var i = parseInt(index / col);
                var j = index % col;
                var arr=[];
                // if(j== col-1){
                // 	arr=[index,index-1,index+col,index-col]; //index+1,

                // }

                switch(j){
                	case 0:
                	arr=[index,index+1,index+col,index-col];//index-1,
                	break;
                	case col-1:
                	arr=[index,index-1,index+col,index-col]; 
                	break;
                	default:
                	arr=[index,index+1,index-1,index+col,index-col];
                	break;
                }

			
				// p.toggleColor(item)
				var status="ok"
				_.$(".debris").forEach(function(t,i){
					if(arr.indexOf(i)>=0){
						// p.toggleColor(t)
						p.toggleImg(t)
					}

					if(!t.hasClass('active')){
						status="notok"
					}

				})
				p.step++
				_.$(".step").html(p.step);

			// 	setTimeout(function(){
					
			// },10)
				if(status=="ok"){
					alert("ok")
				}
				// p.toggleColor(item.next())

			}

		})

    })

		
		
	</script>
	
</body>
</html>