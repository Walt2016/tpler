<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
    <title>tpler events</title>
    <link rel="stylesheet" href="css/tpler.min.css">
    <script src="js/custom/tpler.js"></script>
</head>

<body>
    <div class="container">
        <div class="main" id="password">
            <div template="_password_tpl" class="flex"></div>
        </div>
        <div template="_keyboard_tpl" class="animated fadeInUp hide" id="keyboard"></div>
    </div>
    <script type="text/template" id="_password_tpl">
        <div class="screen screen43 rlt transparent" id="password_head">
            <div class="screen screen43 abs  bgblur" {=topbackground|avatar}></div>
            <div class="ipt_group" id="password_input_group">
                <div class="title">
                    <div class="line_left"></div>请输入直播厅密码
                    <div class="line_right"></div>
                </div>
                <div class="ipt" id="password_input" template="_password_input_tpl"></div>
            </div>
            <div class="screen_tip {=tip|showorhide}" id="password_tip">
                <div class="text">{=tip}</div>
                {=url|viewurl}
            </div>
            <div class="load hide" id="password_loadShow">
                <div class="loadLogo"></div>
                <div class="loadAnimation">
                    <div class="loadBackImg"></div>
                    <div class="loadAnimationImg"></div>
                </div>
            </div>
        </div>
        <div id="password_bottom" class="scrolleWrapper" data-flex="1">
            <div class="scroller">
                {=bottomurl|file}
            </div>
        </div>
    </script>
    <script type="text/template" id="_keyboard_tpl">
        <div class="row">
            <div class="col">
                <div class="btn" name="entryBtn" data-num="1">1</div>
            </div>
            <div class="col">
                <div class="btn" name="entryBtn" data-num="2">2</div>
            </div>
            <div class="col">
                <div class="btn" name="entryBtn" data-num="3">3</div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="btn" name="entryBtn" data-num="4">4</div>
            </div>
            <div class="col">
                <div class="btn" name="entryBtn" data-num="5">5</div>
            </div>
            <div class="col">
                <div class="btn" name="entryBtn" data-num="6">6</div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="btn" name="entryBtn" data-num="7">7</div>
            </div>
            <div class="col">
                <div class="btn" name="entryBtn" data-num="8">8</div>
            </div>
            <div class="col">
                <div class="btn" name="entryBtn" data-num="9">9</div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="btn">&nbsp;</div>
            </div>
            <div class="col">
                <div class="btn" name="entryBtn" data-num="0">0</div>
            </div>
            <div class="col">
                <div class="btn" name="backBtn" on="backHandler">
                    <span>
                              <i class="deleteBtn"></i>
                            </span>
                </div>
            </div>
        </div>
    </script>
    <script type="text/template" id="_password_input_tpl">
        <div class="tinyline {=text|active}">{=text}</div>
    </script>
    <script>
    var kb = {
        ipts: [],
        //输入数字
        input: function(num) {
            var self = this;
            self.ipts.push(num);
            var len = self.ipts.length;
            _.$("#password_input div")[len - 1].html(num).active();

        },
        //退格
        back: function() {
            var self = this,
                len = self.ipts.length;
            if (len > 0) {
                _.$("#password_input div")[len - 1].html("").passive();
                self.ipts.length--;
            }
        },
        //提交密码验证
        submit: function() {
            var self = this,
                verify = self.ipts.join(""),
                len = self.ipts.length;
            if (len == 4) {
                var success = function() {}
                var error = function(data) {
                    alert(data);
                    self.ipts.length = 0;
                    self.initInput();
                }
                setTimeout(function() {
                    _.hide("#password_input_group", "#password_tip,#keyboard")
                    _.show("#password_loadShow");

                }, 500);

                setTimeout(function() {
                    // bo.verify(verify, success, error)
                    alert("提交密码验证")
                }, 1200)
            }
        },
        initInput: function() {
            var self = this,
                len = self.ipts.length,
                data = self.ipts.slice();
            if (len < 4) {
                for (var i = 0; i < 4 - len; i++) {
                    data.push("");
                }
            }

            tpler({
                el: "#password_input",
                data: data,
                filters: {
                    active: function(val) {
                        return val ? "active" : ""
                    }
                },
                callback: function() {
                    _.hide("#password_input_group", "#password_tip")
                    _.show("#password_loadShow");
                    setTimeout(function() {
                        _.show("#password_input_group", "#password_tip")
                        _.hide("#password_loadShow");
                    }, 800)
                }
            })
        },
    }

    tpler([{
        el: "#password",
        data:{},
        events: function(item, ev) {
            var elem = ev.target;
            //elem.nodeName != "a" && !elem.hasAttr("on") &&
            if (_.size(elem.closest("#password_head")) > 0) {
                if (!elem.hasAttr("data-url") && _.size(elem.closest("#keyboard")) == 0) {
                    _.isShow("#keyboard") ? _.hide("#keyboard") : _.show("#keyboard")
                }
            }
        },

    }, {
        el: "#keyboard",
        events: {
            touchstart: function(item, ev) {
                var btn = ev.target.closest(".btn");
                if(!btn) return false;
                var attr = btn.attr('name');
                if (attr == "entryBtn") {
                    if (kb.ipts.length >= 4) {
                        return;
                    }
                    var num = btn.attr("data-num");
                    kb.input(num);
                    kb.submit();

                } else if (attr == "backBtn") {
                    kb.back();
                }
            }
        }
    }])
    kb.initInput();
    </script>
</body>

</html>